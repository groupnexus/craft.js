"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@craftjs/utils"),t=require("react"),n=require("tiny-invariant"),r=require("touch-dnd-custom-events"),o=require("immer"),a=require("shortid");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var d=i(t),s=i(n),u=i(r),c=i(a),l=function(e,t){return(l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function f(e,t){function n(){this.constructor=e}l(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var p=function(){return(p=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function v(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}function h(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),o=0;for(t=0;t<n;t++)for(var a=arguments[t],i=0,d=a.length;i<d;i++,o++)r[o]=a[i];return r}var N=t.createContext(null),E=function(){return t.useContext(N)},g=function(e,t,n){return[e,t,n]},m=function(){function e(e,t,n,r){var o=this;this.el=t,this.opts=n,this.handler=r,this.unsubscribe=e.subscribe((function(e){return{enabled:e.options.enabled}}),(function(e){var n=e.enabled;if(!document.body.contains(t))return o.remove(),o.unsubscribe();n?o.add():o.remove()}),!0)}return e.prototype.add=function(){var e=this,t=this.handler,n=t.init,r=t.events;this.cleanDOM=n&&n(this.el,this.opts),this.listenersToRemove=r&&r.map((function(t){var n=t[0],r=t[1],o=t[2],a=function(t){t.craft||(t.craft={blockedEvents:{},stopPropagation:function(){}}),function(e,t,n){for(var r=e.craft&&e.craft.blockedEvents[t]||[],o=0;o<r.length;o++){var a=r[o];if(n!==a&&n.contains(a))return!0}return!1}(t,n,e.el)||(t.craft.stopPropagation=function(){t.craft.blockedEvents[n]||(t.craft.blockedEvents[n]=[]),t.craft.blockedEvents[n].push(e.el)},r(t,e.opts))};return e.el.addEventListener(n,a,o),function(){return e.el.removeEventListener(n,a,o)}}))},e.prototype.remove=function(){this.cleanDOM&&(this.cleanDOM(),this.cleanDOM=null),this.listenersToRemove&&(this.listenersToRemove.forEach((function(e){return e()})),this.listenersToRemove=null)},e}(),y=function(){function t(e){this.wm=new WeakMap,this.store=e}return t.prototype.connectors=function(){var t=this,n=this.handlers()||{};return Object.keys(n).reduce((function(r,o){var a=n[o],i=a.init,d=a.events;return i||d?(r[o]=e.wrapHookToRecognizeElement((function(e,n){var r;if(e&&document.body.contains(e)){var a=t.wm.get(e);a&&a[o]||t.wm.set(e,p(p({},a),((r={})[o]=new m(t.store,e,n,{init:i,events:d}),r)))}else t.wm.delete(e)})),r):(r[o]=function(){},r)}),{})},t.getConnectors=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=new(this.bind.apply(this,h([void 0],e)));return n.connectors()},t}(),O=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return f(t,e),t.prototype.derive=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return new(e.bind.apply(e,h([void 0,this.store,this],t)))},t}(y),R=function(e){function t(t,n){var r=e.call(this,t)||this;return r.derived=n,r}return f(t,e),t}(y),_=function(e){var t=e.target.cloneNode(!0),n=e.target.getBoundingClientRect(),r=n.height;return t.style.width=n.width+"px",t.style.height=r+"px",t.style.position="fixed",t.style.left="-100%",t.style.top="-100%",document.body.appendChild(t),e.dataTransfer.setDragImage(t,0,0),t},b=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return f(t,e),t.prototype.defineNodeEventListener=function(e,t,n){var r=this;return g(e,(function(e,n){n&&!r.store.query.node(n).get()||t(e,n)}),n)},t.prototype.handlers=function(){var e=this;return u.default(),{select:{init:function(){return function(){return e.store.actions.setNodeEvent("selected",null)}},events:[this.defineNodeEventListener("mousedown",(function(t,n){t.craft.stopPropagation(),e.store.actions.setNodeEvent("selected",n)}))]},hover:{init:function(){return function(){return e.store.actions.setNodeEvent("hovered",null)}},events:[this.defineNodeEventListener("mouseover",(function(t,n){t.craft.stopPropagation(),e.store.actions.setNodeEvent("hovered",n)}))]},drop:{events:[g("dragover",(function(e){e.craft.stopPropagation(),e.preventDefault()})),g("touchdragover",(function(e){e.craft.stopPropagation(),e.preventDefault()})),this.defineNodeEventListener("dragenter",(function(n,r){n.craft.stopPropagation(),n.preventDefault();var o=t.draggedElement;if(o){var a=o;o.rootNodeId&&(a=o.nodes[o.rootNodeId]);var i=e.store.query.getDropPlaceholder(a,r,{x:n.clientX,y:n.clientY});i&&(e.store.actions.setIndicator(i),t.indicator=i)}})),this.defineNodeEventListener("touchdragenter",(function(n,r){n.craft.stopPropagation(),n.preventDefault();var o=t.draggedElement;if(o){var a=o;o.rootNodeId&&(a=o.nodes[o.rootNodeId]);var i=e.store.query.getDropPlaceholder(a,r,{x:n.clientX,y:n.clientY});i&&(e.store.actions.setIndicator(i),t.indicator=i)}}))]},drag:{init:function(t,n){return e.store.query.node(n).isDraggable()?(t.setAttribute("draggable","true"),function(){return t.setAttribute("draggable","false")}):function(){}},events:[this.defineNodeEventListener("dragstart",(function(n,r){n.craft.stopPropagation(),e.store.actions.setNodeEvent("dragged",r),t.draggedElementShadow=_(n),t.draggedElement=r})),this.defineNodeEventListener("touchdragstart",(function(n,r){n.craft.stopPropagation(),e.store.actions.setNodeEvent("dragged",r),t.draggedElementShadow=_(n),t.draggedElement=r})),g("dragend",(function(t){t.craft.stopPropagation(),e.dropElement((function(t,n){e.store.actions.move(t,n.parent.id,n.index+("after"===n.where?1:0))}))})),g("touchend",(function(t){t.craft.stopPropagation(),e.dropElement((function(t,n){e.store.actions.move(t,n.parent.id,n.index+("after"===n.where?1:0))}))}))]},create:{init:function(e){return e.setAttribute("draggable","true"),function(){return e.removeAttribute("draggable")}},events:[g("dragstart",(function(n,r){n.craft.stopPropagation();var o=e.store.query.parseReactElement(r).toNodeTree();t.draggedElementShadow=_(n),t.draggedElement=o})),g("touchdragstart",(function(n,r){n.craft.stopPropagation();var o=e.store.query.parseReactElement(r).toNodeTree();t.draggedElementShadow=_(n),t.draggedElement=o})),g("dragend",(function(t){t.craft.stopPropagation(),e.dropElement((function(t,n){e.store.actions.addNodeTree(t,n.parent.id,n.index+("after"===n.where?1:0))}))})),g("touchend",(function(t){t.craft.stopPropagation(),e.dropElement((function(t,n){e.store.actions.addNodeTree(t,n.parent.id,n.index+("after"===n.where?1:0))}))}))]}}},t.prototype.dropElement=function(e){var n=t.draggedElement,r=t.draggedElementShadow,o=t.indicator;n&&o&&!o.error&&e(n,o.placement),r&&(r.parentNode.removeChild(r),t.draggedElementShadow=null),t.draggedElement=null,t.indicator=null,this.store.actions.setIndicator(null),this.store.actions.setNodeEvent("dragged",null)},t.indicator=null,t}(O),D=t.createContext({});function C(n){var r=E(),o=t.useContext(D),a=e.useCollector(o,n),i=t.useMemo((function(){return r&&r.connectors()}),[r]);return p(p({},a),{connectors:i||{},inContext:!!o,store:o})}var T=function(n){var r,o,a,i,s,u,c,l,f=n.children,v=C((function(e){return{indicator:e.events.indicator,indicatorOptions:e.options.indicator,handlers:e.handlers,handlersFactory:e.options.handlers}})),h=v.actions,E=v.indicator,g=v.indicatorOptions,m=v.store,y=v.handlers,O=v.handlersFactory,R=t.useRef(m);return R.current=m,t.useEffect((function(){h.history.ignore().setState((function(e){return e.handlers=O(R.current)}))}),[h,O]),y?d.default.createElement(N.Provider,{value:y},E&&d.default.createElement(e.RenderIndicator,{style:p(p({},(r=E.placement,o=e.getDOMInfo(E.placement.parent.dom),a=E.placement.currentNode&&e.getDOMInfo(E.placement.currentNode.dom),i=0,s=0,u=0,c=0,l=r.where,a?a.inFlow?(u=a.outerWidth,c=2,i="before"===l?a.top:a.bottom,s=a.left):(u=2,c=a.outerHeight,i=a.top,s="before"===l?a.left:a.left+a.outerWidth):o&&(i=o.top+o.padding.top,s=o.left+o.padding.left,u=o.outerWidth-o.padding.right-o.padding.left-o.margin.left-o.margin.right,c=2),{top:i+"px",left:s+"px",width:u+"px",height:c+"px"})),{backgroundColor:E.error?g.error:g.success,transition:"0.2s ease-in"})}),f):null},I=function(e){function t(t,n,r){var o=e.call(this,t,n)||this;return o.id=r,o}return f(t,e),t.prototype.handlers=function(){var e=this,t=this.derived.connectors();return{connect:{init:function(n){t.select(n,e.id),t.hover(n,e.id),t.drop(n,e.id),e.store.actions.setDOM(e.id,n)}},drag:{init:function(n){t.drag(n,e.id)}}}},t}(R),k=d.default.createContext(null),P=function(e){var n=e.id,r=e.related,o=void 0!==r&&r,a=e.children,i=E(),s=C((function(e){return{hydrationTimestamp:e.nodes[n]&&e.nodes[n]._hydrationTimestamp}})).hydrationTimestamp,u=t.useMemo((function(){return i.derive(I,n).connectors()}),[i,s,n]);return d.default.createElement(k.Provider,{value:{id:n,related:o,connectors:u}},a)};function x(e){var n=t.useContext(k),r=n.id,o=n.related,a=n.connectors,i=C((function(t){return r&&t.nodes[r]&&e&&e(t.nodes[r])})),d=i.actions,s=v(i,["actions","query"]),u=t.useMemo((function(){return{setProp:function(e,t){t?d.history.throttle(t).setProp(r,e):d.setProp(r,e)},setCustom:function(e,t){t?d.history.throttle(t).setCustom(r,e):d.setCustom(r,e)},setHidden:function(e){return d.setHidden(r,e)}}}),[d,r]);return p(p({},s),{id:r,related:o,inNodeContext:!!n,actions:u,connectors:a})}function L(t){var n=x(t),r=n.id,o=n.related,a=n.actions,i=n.inNodeContext,d=n.connectors,s=v(n,["id","related","actions","inNodeContext","connectors"]);return p(p({},s),{actions:a,id:r,related:o,setProp:function(t){return e.deprecationWarning("useNode().setProp()",{suggest:"useNode().actions.setProp()"}),a.setProp(t)},inNodeContext:i,connectors:d})}var j=function(e){var t=e.render,n=L().connectors;return"string"==typeof t.type?(0,n.connect)((0,n.drag)(d.default.cloneElement(t))):t},w=function(){var e=x((function(e){return{type:e.data.type,props:e.data.props,nodes:e.data.nodes,hydrationTimestamp:e._hydrationTimestamp}})),n=e.type,r=e.props,o=e.nodes;return t.useMemo((function(){var e=r.children;o&&o.length>0&&(e=d.default.createElement(d.default.Fragment,null,o.map((function(e){return d.default.createElement(M,{id:e,key:e})}))));var t=d.default.createElement(n,r,e);return"string"==typeof n?d.default.createElement(j,{render:t}):t}),[n,r,e.hydrationTimestamp,o])},A=function(){var e=x((function(e){return{hidden:e.data.hidden}})).hidden,t=C((function(e){return{onRender:e.options.onRender}})).onRender;return e?null:d.default.createElement(t,{render:d.default.createElement(w,null)})},M=d.default.memo((function(e){return d.default.createElement(P,{id:e.id},d.default.createElement(A,null))})),S={is:"div",canvas:!1,custom:{},hidden:!1},q={is:"type",canvas:"isCanvas"};function V(n){var r=n.id,o=n.children,a=v(n,["id","children"]),i=p(p({},S),a),u=i.is,c=v(i,["is","custom","canvas"]),l=C(),f=l.query,h=l.actions,N=x((function(e){return{node:{id:e.id,data:e.data}}})),E=N.node,g=N.inNodeContext,m=t.useState(null),y=m[0],O=m[1];return e.useEffectOnce((function(){s.default(!!r,e.ERROR_TOP_LEVEL_ELEMENT_NO_ID);var t=E.id,n=E.data;if(g){var i,l=n.linkedNodes&&n.linkedNodes[r]&&f.node(n.linkedNodes[r]).get();if(l&&l.data.type===u){i=l.id;var v=p(p({},l.data.props),c);h.history.ignore().setProp(i,(function(e){return Object.keys(v).forEach((function(t){return e[t]=v[t]}))}))}else{var N=d.default.createElement(V,a,o),m=f.parseReactElement(N).toNodeTree();i=m.rootNodeId,h.history.ignore().addLinkedNodeFromTree(m,t,r)}O(i)}})),y?d.default.createElement(M,{id:y}):null}var H=function(){return e.deprecationWarning("<Canvas />",{suggest:"<Element canvas={true} />"})};function Canvas(e){var n=v(e,[]);return t.useEffect((function(){return H()}),[]),d.default.createElement(V,p({},n,{canvas:!0}))}var z=function(e){return v(e,["addLinkedNodeFromTree","setDOM","setNodeEvent","replaceNodes","reset"])};function F(e){var n=C(e),r=n.connectors,o=n.actions,a=v(n.query,["deserialize"]),i=n.store,d=v(n,["connectors","actions","query","store"]),s=z(o),u=t.useMemo((function(){return p(p({},s),{history:p(p({},s.history),{ignore:function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return z((e=s.history).ignore.apply(e,t))},throttle:function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return z((e=s.history).throttle.apply(e,t))}})})}),[s]);return p({connectors:r,actions:u,query:a,store:i},d)}var W=function(e){return Object.fromEntries?Object.fromEntries(e):e.reduce((function(e,t){var n,r=t[0],o=t[1];return p(p({},e),((n={})[r]=o,n))}),{})},G=function(e,t){var n=t.name||t.displayName;if(t===Canvas)return"Canvas";if(e[n])return n;for(var r=0;r<Object.keys(e).length;r++){var o=Object.keys(e)[r];if(e[o]===t)return o}return"string"==typeof t?t:void 0},J=function(e,t){return"string"==typeof e?e:{resolvedName:G(t,e)}},B=function(e,n){var r=e.type,o=e.isCanvas,a=e.props;return a=Object.keys(a).reduce((function(e,r){var o=a[r];return null==o||(e[r]="children"===r&&"string"!=typeof o?t.Children.map(o,(function(e){return"string"==typeof e?e:B(e,n)})):o.type?B(o,n):o),e}),{}),{type:J(r,n),isCanvas:!!o,props:a}},U=c.default;function X(e,t){var n=e.data.type,r=e.id||U();return o.produce({},(function(o){if(o.id=r,o._hydrationTimestamp=Date.now(),o.data=p({type:n,props:p({},e.data.props),name:"string"==typeof n?n:n.name,displayName:"string"==typeof n?n:n.name,custom:{},isCanvas:!1,hidden:!1,nodes:[],linkedNodes:{}},e.data),o.related={},o.events={selected:!1,dragged:!1,hovered:!1},o.rules=p({canDrag:function(){return!0},canDrop:function(){return!0},canMoveIn:function(){return!0},canMoveOut:function(){return!0}},n.craft&&n.craft.rules||{}),o.data.type===V||o.data.type===Canvas){var a=o.data.type===Canvas,i=p(p({},S),o.data.props);Object.keys(S).forEach((function(e){o.data[q[e]||e]=i[e],delete o.data.props[e]})),n=o.data.type,a&&(o.data.isCanvas=!0,H())}if(t&&t(o),n.craft){o.data.props=p(p({},n.craft.props||n.craft.defaultProps||{}),o.data.props);var s=n.craft.displayName||n.craft.name;if(s&&(o.data.displayName=s),n.craft.isCanvas&&(o.data.isCanvas=o.data.isCanvas||n.craft.isCanvas),n.craft.rules&&Object.keys(n.craft.rules).forEach((function(e){["canDrag","canDrop","canMoveIn","canMoveOut"].includes(e)&&(o.rules[e]=n.craft.rules[e])})),n.craft.custom&&(o.data.custom=p(p({},n.craft.custom),o.data.custom)),n.craft.related){o.related={};var u={id:o.id,related:!0};Object.keys(n.craft.related).forEach((function(e){o.related[e]=function(){return d.default.createElement(P,u,d.default.createElement(n.craft.related[e]))}}))}}}))}var Y=function(e,t,n){var r=e.props,o=function(e,t){return"object"==typeof e&&e.resolvedName?"Canvas"===e.resolvedName?Canvas:t[e.resolvedName]:"string"==typeof e?e:null}(e.type,t);if(o){r=Object.keys(r).reduce((function(e,n){var o=r[n];return e[n]=null==o?null:"object"==typeof o&&o.resolvedName?Y(o,t):"children"===n&&Array.isArray(o)?o.map((function(e){return"string"==typeof e?e:Y(e,t)})):o,e}),{}),n&&(r.key=n);var a=p({},d.default.createElement(o,p({},r)));return p(p({},a),{name:G(t,a.type)})}},Z=function(e,t){var n,r;if(t.length<1)return(n={})[e.id]=e,n;var o=t.map((function(e){return e.rootNodeId})),a=p(p({},e),{data:p(p({},e.data),{nodes:o})}),i=((r={})[e.id]=a,r);return t.reduce((function(t,n){var r,o=n.nodes[n.rootNodeId];return p(p(p({},t),n.nodes),((r={})[o.id]=p(p({},o),{data:p(p({},o.data),{parent:e.id})}),r))}),i)};function K(n){var r=n&&n.options,o=function(){return K(n)};return{getDropPlaceholder:function(t,r,a,i){if(void 0===i&&(i=function(e){return n.nodes[e.id].dom}),t!==r){var d="string"==typeof t&&n.nodes[t],s=n.nodes[r],u=o().node(s.id).isCanvas()?s:n.nodes[s.data.parent];if(u){var c=u.data.nodes||[],l=function(e,t,n,r){for(var o={parent:e,index:0,where:"before"},a=0,i=0,d=0,s=0,u=0,c=0,l=0,f=t.length;l<f;l++){var p=t[l];if(c=p.top+p.outerHeight,s=p.left+p.outerWidth/2,u=p.top+p.outerHeight/2,!(i&&p.left>i||d&&u>=d||a&&p.left+p.outerWidth<a))if(o.index=l,p.inFlow){if(r<u){o.where="before";break}o.where="after"}else r<c&&(d=c),n<s?(i=s,o.where="before"):(a=s,o.where="after")}return o}(u,c?c.reduce((function(t,r){var o=i(n.nodes[r]);if(o){var a=p({id:r},e.getDOMInfo(o));t.push(a)}return t}),[]):[],a.x,a.y),f=c.length&&n.nodes[c[l.index]],v={placement:p(p({},l),{currentNode:f}),error:!1};return d&&o().node(d.id).isDraggable((function(e){return v.error=e})),o().node(u.id).isDroppable(t,(function(e){return v.error=e})),v}}},getOptions:function(){return r},node:function(t){return function t(n,r){s.default("string"==typeof r,e.ERROR_INVALID_NODE_ID);var o=n.nodes[r],a=function(e){return t(n,e)};return{isCanvas:function(){return!!o.data.isCanvas},isRoot:function(){return o.id===e.ROOT_NODE},isLinkedNode:function(){return o.data.parent&&a(o.data.parent).linkedNodes().includes(o.id)},isTopLevelNode:function(){return this.isRoot()||this.isLinkedNode()},isDeletable:function(){return!this.isTopLevelNode()},isParentOfTopLevelNodes:function(){return o.data.linkedNodes&&Object.keys(o.data.linkedNodes).length>0},isParentOfTopLevelCanvas:function(){return e.deprecationWarning("query.node(id).isParentOfTopLevelCanvas",{suggest:"query.node(id).isParentOfTopLevelNodes"}),this.isParentOfTopLevelNodes()},get:function(){return o},ancestors:function(e){return void 0===e&&(e=!1),function t(r,o,a){void 0===o&&(o=[]),void 0===a&&(a=0);var i=n.nodes[r];return i?(o.push(r),i.data.parent?((e||!e&&0===a)&&(o=t(i.data.parent,o,a+1)),o):o):o}(o.data.parent)},descendants:function(e,t){return void 0===e&&(e=!1),function r(o,i,d){return void 0===i&&(i=[]),void 0===d&&(d=0),(e||!e&&0===d)&&n.nodes[o]?("childNodes"!==t&&a(o).linkedNodes().forEach((function(e){i.push(e),i=r(e,i,d+1)})),"linkedNodes"!==t&&a(o).childNodes().forEach((function(e){i.push(e),i=r(e,i,d+1)})),i):i}(r)},linkedNodes:function(){return Object.values(o.data.linkedNodes||{})},childNodes:function(){return o.data.nodes||[]},isDraggable:function(r){try{var i=o;return s.default(!this.isTopLevelNode(),e.ERROR_MOVE_TOP_LEVEL_NODE),s.default(t(n,i.data.parent).isCanvas(),e.ERROR_MOVE_NONCANVAS_CHILD),s.default(i.rules.canDrag(i,a),e.ERROR_CANNOT_DRAG),!0}catch(e){return r&&r(e),!1}},isDroppable:function(t,r){var i="object"==typeof t&&!n.nodes[t.id],d=function(e){return"string"==typeof e?n.nodes[e]:e}(t),u=o;try{if("string"==typeof t&&s.default(!a(t).isTopLevelNode(),e.ERROR_MOVE_TOP_LEVEL_NODE),s.default(this.isCanvas(),e.ERROR_MOVE_TO_NONCANVAS_PARENT),s.default(u.rules.canMoveIn(d,u,a),e.ERROR_MOVE_INCOMING_PARENT),s.default(d.rules.canDrop(u,d,a),e.ERROR_MOVE_CANNOT_DROP),i)return!0;var c=a(d.id).descendants(!0);s.default(!c.includes(u.id)&&u.id!==d.id,e.ERROR_MOVE_TO_DESCENDANT);var l=d.data.parent&&n.nodes[d.data.parent];return s.default(l.data.isCanvas,e.ERROR_MOVE_NONCANVAS_CHILD),s.default(l||!l&&!n.nodes[d.id],e.ERROR_DUPLICATE_NODEID),o!==l&&s.default(l.rules.canMoveOut(d,l,a),e.ERROR_MOVE_OUTGOING_PARENT),!0}catch(e){return r&&r(e),!1}},toSerializedNode:function(){return t=n.options.resolver,r=(e=o.data).type,a=e.props,i=e.isCanvas,d=v(e,["type","props","isCanvas","name"]),s=B({type:r,isCanvas:i,props:a},t),p(p({},s),d);var e,t,r,a,i,d,s},toNodeTree:function(e){var t=h([r],this.descendants(!0,e)).reduce((function(e,t){return e[t]=a(t).get(),e}),{});return{rootNodeId:r,nodes:t}},decendants:function(t){return void 0===t&&(t=!1),e.deprecationWarning("query.node(id).decendants",{suggest:"query.node(id).descendants"}),this.descendants(t)},isTopLevelCanvas:function(){return!this.isRoot()&&!o.data.parent}}}(n,t)},getSerializedNodes:function(){var e=this,t=Object.keys(n.nodes).map((function(t){return[t,e.node(t).toSerializedNode()]}));return W(t)},serialize:function(){return JSON.stringify(this.getSerializedNodes())},parseReactElement:function(r){return{toNodeTree:function(a){var i=function(e,n){var r=e;return"string"==typeof r&&(r=d.default.createElement(t.Fragment,{},r)),X({data:{type:r.type,props:p({},r.props)}},(function(e){n&&n(e,r)}))}(r,(function(t,r){var o=G(n.options.resolver,t.data.type);s.default(null!==o,e.ERROR_NOT_IN_RESOLVER),t.data.displayName=t.data.displayName||o,t.data.name=o,a&&a(t,r)})),u=[];return r.props&&r.props.children&&(u=d.default.Children.toArray(r.props.children).reduce((function(e,t){return d.default.isValidElement(t)&&e.push(o().parseReactElement(t).toNodeTree(a)),e}),[])),function(e,t){return{rootNodeId:e.id,nodes:Z(e,t)}}(i,u)}}},parseSerializedNode:function(t){return{toNode:function(r){var a=function(t,n){var r=t.type,o=v(t,["type","props"]);s.default(void 0!==r&&"string"==typeof r||void 0!==r&&void 0!==r.resolvedName,e.ERROR_DESERIALIZE_COMPONENT_NOT_IN_RESOLVER.replace("%displayName%",t.displayName).replace("%availableComponents%",Object.keys(n).join(", ")));var a=Y(t,n),i=a.name;return{type:a.type,name:i,displayName:o.displayName||i,props:a.props,custom:o.custom||{},isCanvas:!!o.isCanvas,hidden:!!o.hidden,parent:o.parent,linkedNodes:o.linkedNodes||o._childCanvas||{},nodes:o.nodes||[]}}(t,n.options.resolver);s.default(a.type,e.ERROR_NOT_IN_RESOLVER);var i="string"==typeof r&&r;return i&&e.deprecationWarning("query.parseSerializedNode(...).toNode(id)",{suggest:"query.parseSerializedNode(...).toNode(node => node.id = id)"}),o().parseFreshNode(p(p({},i?{id:i}:{}),{data:a})).toNode(!i&&r)}}},parseFreshNode:function(t){return{toNode:function(r){return X(t,(function(t){t.data.parent===e.DEPRECATED_ROOT_NODE&&(t.data.parent=e.ROOT_NODE);var o=G(n.options.resolver,t.data.type);s.default(null!==o,e.ERROR_NOT_IN_RESOLVER),t.data.displayName=t.data.displayName||o,t.data.name=o,r&&r(t)}))}}},createNode:function(t,n){e.deprecationWarning("query.createNode("+t+")",{suggest:"query.parseReactElement("+t+").toNodeTree()"});var r=this.parseReactElement(t).toNodeTree(),o=r.nodes[r.rootNodeId];return n?(n.id&&(o.id=n.id),n.data&&(o.data=p(p({},o.data),n.data)),o):o},getState:function(){return n}}}var Q={nodes:{},events:{dragged:null,selected:null,hovered:null,indicator:null},handlers:null,options:{onNodesChange:function(){return null},onRender:function(e){return e.render},resolver:{},enabled:!0,indicator:{error:"red",success:"rgb(98, 196, 98)"},handlers:function(e){return new b(e)}}},$={methods:function(t,n){return p(p({},function(t,n){var r=function(e,n,r){var o=a(n);o.data.nodes||(o.data.nodes=[]),o.data.props.children&&delete o.data.props.children,null!=r?o.data.nodes.splice(r,0,e.id):o.data.nodes.push(e.id),e.data.parent=o.id,t.nodes[e.id]=e},o=function(e,n,a){var i=e.nodes[e.rootNodeId];if(null!=n&&r(i,n,a),i.data.nodes){var d=h(i.data.nodes);i.data.nodes=[],d.forEach((function(t,n){return o({rootNodeId:t,nodes:e.nodes},i.id,n)}))}i.data.linkedNodes&&Object.keys(i.data.linkedNodes).forEach((function(n){var r=i.data.linkedNodes[n];t.nodes[r]=e.nodes[r],o({rootNodeId:r,nodes:e.nodes})}))},a=function(n){s.default(n,e.ERROR_NOPARENT);var r=t.nodes[n];return s.default(r,e.ERROR_INVALID_NODEID),r},i=function(e,n){void 0===n&&(n=!1);var r=t.nodes[e],o=t.nodes[r.data.parent];if(r.data.nodes&&h(r.data.nodes).forEach((function(e){return i(e)})),n&&o.data.linkedNodes){var a=Object.keys(o.data.linkedNodes).filter((function(e){return o.data.linkedNodes[e]===e}))[0];a&&delete o.data.linkedNodes[a]}else{var d=o.data.nodes;d.splice(d.indexOf(e),1)}!function(e,t){Object.keys(e.events).forEach((function(n){e.events[n]&&e.events[n]===t&&(e.events[n]=null)}))}(t,e),delete t.nodes[e]};return{addLinkedNodeFromTree:function(e,n,r){var d=a(n);d.data.linkedNodes||(d.data.linkedNodes={});var s=d.data.linkedNodes[r];s&&i(s,!0),d.data.linkedNodes[r]=e.rootNodeId,e.nodes[e.rootNodeId].data.parent=n,t.nodes[e.rootNodeId]=e.nodes[e.rootNodeId],o(e)},add:function(t,n,o){var a=[t];Array.isArray(t)&&(e.deprecationWarning("actions.add(node: Node[])",{suggest:"actions.add(node: Node)"}),a=t),a.forEach((function(e){r(e,n,o)}))},addNodeTree:function(n,r,a){var i=n.nodes[n.rootNodeId];r||(s.default(n.rootNodeId===e.ROOT_NODE,"Cannot add non-root Node without a parent"),t.nodes[n.rootNodeId]=i),o(n,r,a)},delete:function(t){s.default(!n.node(t).isTopLevelNode(),e.ERROR_DELETE_TOP_LEVEL_NODE),i(t)},deserialize:function(t){var r="string"==typeof t?JSON.parse(t):t,o=Object.keys(r).map((function(t){var o=t;return t===e.DEPRECATED_ROOT_NODE&&(o=e.ROOT_NODE),[o,n.parseSerializedNode(r[t]).toNode((function(e){return e.id=o}))]}));this.replaceNodes(W(o))},move:function(e,r,o){var a=t.nodes[e],i=a.data.parent,d=t.nodes[r].data.nodes;n.node(r).isDroppable(a,(function(e){throw new Error(e)}));var s=t.nodes[i].data.nodes;s[s.indexOf(e)]="marked",d.splice(o,0,e),t.nodes[e].data.parent=r,s.splice(s.indexOf("marked"),1)},replaceNodes:function(e){t.nodes=e,this.clearEvents()},clearEvents:function(){this.setNodeEvent("selected",null),this.setNodeEvent("hovered",null),this.setNodeEvent("dragged",null),this.setIndicator(null)},reset:function(){this.clearEvents(),this.replaceNodes({})},setOptions:function(e){e(t.options)},setNodeEvent:function(e,n){var r=t.events[e];r&&n!==r&&(t.nodes[r].events[e]=!1),n?(t.nodes[n].events[e]=!0,t.events[e]=n):t.events[e]=null},setCustom:function(e,n){n(t.nodes[e].data.custom)},setDOM:function(n,r){s.default(t.nodes[n],e.ERROR_INVALID_NODEID),t.nodes[n].dom=r},setIndicator:function(e){e&&(!e.placement.parent.dom||e.placement.currentNode&&!e.placement.currentNode.dom)||(t.events.indicator=e)},setHidden:function(e,n){t.nodes[e].data.hidden=n},setProp:function(n,r){s.default(t.nodes[n],e.ERROR_INVALID_NODEID),r(t.nodes[n].data.props)},selectNode:function(e){this.setNodeEvent("selected",null!=e?e:null),this.setNodeEvent("hovered",null)}}}(t,n)),{setState:function(e){var n=v(this,["history"]);e(t,n)}})},ignoreHistoryForActions:["setDOM","setNodeEvent","selectNode","clearEvents","setOptions","setIndicator"],normalizeHistory:function(e){Object.keys(e.events).forEach((function(t){var n=e.events[t];n&&!e.nodes[n]&&(e.events[t]=!1)})),Object.keys(e.nodes).forEach((function(t){var n=e.nodes[t];Object.keys(n.events).forEach((function(t){n.events[t]&&!e.events[t]!==n.id&&(n.events[t]=!1)}))}))}},ee=function(t){return e.useMethods($,p(p({},Q),{options:p(p({},Q.options),t)}),K)};Object.defineProperty(exports,"ROOT_NODE",{enumerable:!0,get:function(){return e.ROOT_NODE}}),exports.ActionMethodsWithConfig=$,exports.Canvas=Canvas,exports.CoreEventHandlers=O,exports.DefaultEventHandlers=b,exports.DerivedEventHandlers=R,exports.Editor=function(n){var r=n.children,o=v(n,["children"]);void 0!==o.resolver&&s.default("object"==typeof o.resolver&&!Array.isArray(o.resolver),e.ERROR_RESOLVER_NOT_AN_OBJECT);var a=ee(o);return t.useEffect((function(){a&&o&&a.actions.setOptions((function(e){}))}),[a,o]),t.useEffect((function(){a.subscribe((function(e){return{json:a.query.serialize()}}),(function(){a.query.getOptions().onNodesChange(a.query)}))}),[a]),a?d.default.createElement(D.Provider,{value:a},d.default.createElement(T,null,r)):null},exports.Element=V,exports.Events=T,exports.Frame=function(n){var r=n.children,o=n.json,a=n.data,i=C(),s=i.actions,u=i.query,c=t.useState(null),l=c[0],f=c[1];o&&e.deprecationWarning("<Frame json={...} />",{suggest:"<Frame data={...} />"});var p=t.useRef({initialChildren:r,initialData:a||o});return t.useEffect((function(){var t=p.current,n=t.initialChildren,r=t.initialData;if(r)s.history.ignore().deserialize(r);else if(n){var o=d.default.Children.only(n),a=u.parseReactElement(o).toNodeTree((function(t,n){return n===o&&(t.id=e.ROOT_NODE),t}));s.history.ignore().addNodeTree(a)}f(d.default.createElement(M,{id:e.ROOT_NODE}))}),[s,u]),l},exports.Handlers=y,exports.NodeContext=k,exports.NodeProvider=P,exports.connectEditor=function(e){return function(t){return function(n){var r=e?F(e):F();return d.default.createElement(t,p({},r,n))}}},exports.connectNode=function(e){return function(t){return function(n){var r=L(e);return d.default.createElement(t,p({},r,n))}}},exports.defaultElementProps=S,exports.defineEventListener=g,exports.deprecateCanvasComponent=H,exports.editorInitialState=Q,exports.elementPropToNodeData=q,exports.useEditor=F,exports.useEditorStore=ee,exports.useEventHandler=E,exports.useNode=L;
